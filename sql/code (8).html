<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Proposal - Nutz Technovation</title>
    <style>
      /* Base Styles - Add this if not already present */
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f8f9fa; /* Light grey background for screen view */
        color: #000;
        font-size: 10pt;
      }

      /* Container Styling */
      #proposal-content {
        width: 210mm; /* A4 width */
        min-height: 297mm; /* A4 height */
        margin: 20px auto; /* Center on screen */
        background-color: #fff; /* Solid white background for the container */
        padding: 15mm 20mm; /* Approximate margins */
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.2); /* Shadow for screen */
        box-sizing: border-box;
        position: relative; /* CRITICAL: Needed for pseudo-element positioning */
        overflow: hidden; /* Optional: Prevents potential overflow issues */
        z-index: 1; /* Ensure container context is above default */
      }

      /* --- Watermark using Pseudo-element --- */
      #proposal-content::before {
         content: ""; /* Required for pseudo-elements */
         position: absolute; /* Position relative to #proposal-content */
         top: 0;
         left: 0;
         right: 0;
         bottom: 0;
         /* --- Your Background Image Settings --- */
         /* background-image: url('YOUR_WATERMARK_IMAGE.png'); /* Uncomment and set your image */
         background-repeat: no-repeat;        /* Correct value */
         background-position: center center;   /* Center the image (adjust as needed) */
         background-size: contain; /* Or 'cover', depending on need */
         opacity: 0.08; /* Opacity for watermark */
         z-index: 0; /* Place watermark BEHIND the content */
      }

      /* --- Ensure Content is Above Watermark --- */
      #proposal-content > .header,
      #proposal-content > .details-section,
      #proposal-content > .table-area,
      #proposal-content > .totals-section,
      #proposal-content > .footer-sections {
         position: relative;
         z-index: 1;
         background-color: transparent; /* Allow watermark to show through */
      }

      /* === Specific Element Styles (Mostly unchanged) === */
      .header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 25px;
        padding-bottom: 10px;
      }
      .header .logo img {
        max-width: 270px; /* Adjusted logo size */
        height: auto;
        margin-right: 20px;
        max-height: 100px; /* Added max height constraint */
        width: auto; /* Allow width to adjust based on height */
      }
      .header .company-details {
        text-align: right;
        font-size: 11pt;
        margin-top:18px;
        line-height: 1.4;
        flex-grow: 2;
      }
      .company-details .company-name {
        font-weight: bold;
        font-size: 11pt;
        margin-bottom: 4px;
        display: block;
      }
      .company-details .company-gstin {
        font-weight: bold;
        margin-top: 4px;
        display: inline-block;
      }
      .details-section {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 30px;
        font-size: 10pt;
        line-height: 1.7;
      }
      .details-section .recipient-details {
        width: 55%;
        margin-top: 20px;
      }
      .details-section .quotation-details-wrapper {
        margin-top: 40px;
        width: 37%;
        display: flex;
        justify-content: flex-end;
      }
      .recipient-details h2 {
        font-size: 13pt;
        font-weight: bold;
        margin: 0 0 10px 0;
        padding-bottom: 3px;
        border-bottom: 1.5px solid #000;
        display: inline-block;
      }
      .recipient-details p {
        margin: 2px 0;
      }
      .recipient-details .label {
        display: inline-block;
        font-weight: bold;
        width: 70px;
      }
      .recipient-details .separator {
        display: inline-block;
        width: 10px;
        text-align: center;
      }
      .recipient-details .value {
        display: inline;
        font-weight: bold; /* Made value bold to match image */
      }
      .quotation-details {
        background-color: #282828;
        color: #fff;
        padding: 10px 15px;
        font-size: 9pt;
        line-height: 1.8;
        border-radius: 2px;
        width: 100%;
        box-sizing: border-box;
        position: relative;
        z-index: 2;
      }
      .quotation-details div {
        display: flex;
        justify-content: space-between;
        margin-bottom: 3px;
        font-weight: 700; /* Made text bold */
        padding: 3px 0; /* Added some padding */
      }
      .quotation-details .q-label {
        display: inline-block;
        min-width: 80px;
        text-align: left;
      }
      .quotation-details .q-separator {
        display: inline-block;
        padding: 0 5px;
      }
      .quotation-details .q-value {
        display: inline-block;
        text-align: left;
        flex-grow: 1;
      }
      .table-area {
        margin-bottom: 5px;
      }
      .items-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 9pt;
        background-color: transparent;
        border-top: 1px solid #000;
      }
      .items-table th {
        border-left: 1px solid #000;
        border-right: 1px solid #000;
        border-bottom: 1px solid #000;
        padding: 6px 8px;
        text-align: left;
        background-color: #282828;
        color: #fff;
        font-weight: bold;
      }
      .items-table th.col-qty,
      .items-table th.col-unitprice,
      .items-table th.col-price {
          text-align: center !important;
      }
      .items-table tbody td {
        border-left: 1px solid #000;
        border-right: 1px solid #000;
        border-bottom: 1px solid #000;
        border-top: none;
        padding: 6px 8px;
        text-align: left;
        vertical-align: middle;
        background-color: rgba(255, 255, 255, 0.8); /* Slightly transparent white */
      }
      .items-table td.col-sno,
      .items-table td.col-qty {
          text-align: center !important;
      }
      .items-table td.col-unitprice,
      .items-table td.col-price {
          text-align: right !important;
      }
      .items-table .col-sno { width: 8%; }
      .items-table .col-desc { width: 47%; }
      .items-table .col-qty { width: 10%; }
      .items-table .col-unitprice { width: 17%; }
      .items-table .col-price { width: 18%; }
      /* Style for Note Row */
      .items-table tr.item-note td {
        border-bottom: 1px solid #000;
        border-top: none;
        border-right: 1px solid #000; /* Right border for the last cell */
        border-left: 1px solid #000; /* Left border for the first cell */
        vertical-align: top;
        padding: 8px 8px 8px 16px; /* Add left padding */
        min-height: 30px;
        font-size: 9pt;
        font-style: normal;
        color: #333;
        background-color: rgba(255, 255, 255, 0.8);
      }
      .items-table tr.item-note td span {
        font-weight: bold;
      }
      /* End Note Row Style */
      .totals-section {
        width: 45%;
        margin-left: auto;
        margin-top: 20px;
        margin-bottom: 30px;
        font-size: 10pt;
        line-height: 1.8;
      }
      .totals-section div {
        display: flex;
        justify-content: space-between;
        padding: 1px 0;
        border-bottom: 0.5px solid #ccc;
      }
      .totals-section div.grand-total {
        font-weight: bold;
        border-top: 1.5px solid #000;
        border-bottom: 1.5px solid #000;
        margin-top: 4px;
        padding: 4px 0;
      }
      .totals-section span:first-child {
        padding-right: 20px;
        text-align: left;
      }
      .totals-section span:last-child {
        text-align: right;
        min-width: 80px; /* Ensure enough space for currency */
      }
      .footer-sections {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-top: 40px;
      }
      .terms-section {
        width: 60%;
        margin-bottom: 0;
        position: static;
         margin-top: 36px; /* Adjusted margin */
      }
      .terms-section h3 {
        font-size: 10pt;
        font-weight: bold;
        margin-bottom: 8px;
      }
      .terms-section ol {
        padding-left: 20px;
        margin-left: 5px;
        font-size: 9pt;
        line-height: 1.6;
        margin-top: 0;
      }
      .terms-section li {
        margin-bottom: 4px;
        padding-left: 5px;
      }
      .approval-section {
        width: 35%;
        text-align: left;
        font-size: 10pt;
        line-height: 1.5;
        margin-bottom: 0;
        position: static;
        margin-top: 110px; /* Adjusted margin */
      }
       .approval-section p {
        margin: 0 0 5px 0;
        text-align: center; /* Center align signature lines */
      }
      .approval-section p:first-of-type {
         font-size: 9pt; /* Smaller font for the "For..." line */
      }
      /* Removed signature space div - adjust margins if needed */
      .approval-section .approver-name {
        font-weight: bold;
        margin-top: 45px; /* Add space above name (instead of signature div) */
      }
      .approval-section .approver-title {
        font-size: 9pt;
      }

      /* --- Download Button Styles --- */
      .download-button-container {
        position: fixed; /* Keep it visible */
        bottom: 15px;
        left: 15px;
        z-index: 1000; /* Ensure it's above other content */
      }
      #download-pdf {
        padding: 10px 20px;
        font-size: 10pt;
        cursor: pointer;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 5px;
        box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
        transition: background-color 0.3s ease;
      }
      #download-pdf:hover {
        background-color: #0056b3;
      }

      /* --- Print Styles --- */
      @media print {
         body {
           background-color: #fff !important;
           font-size: 9.5pt;
         }
         #proposal-content {
           box-shadow: none;
           margin: 0;
           width: 100%;
           min-height: initial;
           padding: 0;
           overflow: visible;
           background-color: #fff !important;
         }
         #proposal-content::before {
           opacity: 0.08 !important; /* Match screen opacity */
           /* background-image: url("YOUR_WATERMARK_IMAGE.png") !important; */ /* Ensure watermark image prints */
           -webkit-print-color-adjust: exact;
           print-color-adjust: exact;
         }
         #proposal-content .items-table tbody td,
         #proposal-content .items-table tr.item-note td {
            background-color: rgba(255, 255, 255, 0.8) !important;
             -webkit-print-color-adjust: exact;
             print-color-adjust: exact;
         }
         #proposal-content .items-table th {
             background-color: #282828 !important;
             color: #fff !important;
             -webkit-print-color-adjust: exact;
             print-color-adjust: exact;
         }
         #proposal-content .quotation-details {
             background-color: #282828 !important;
             color: #fff !important;
             -webkit-print-color-adjust: exact;
             print-color-adjust: exact;
         }
         /* --- Hide Download Button during print/PDF generation --- */
         .download-button-container {
           display: none !important;
         }
         /* Page break avoidance rules */
         .footer-sections, .totals-section, .table-area { page-break-inside: avoid; }
         .items-table tbody tr { page-break-inside: avoid; }
         .header, .details-section { page-break-after: avoid; page-break-inside: avoid; }
         h2, h3 { page-break-after: avoid; }
         ol, ul, li { page-break-inside: avoid; }
         .approval-section p:first-of-type { font-size: 9pt !important; }
      }
    </style>
  </head>
  <body>
    <!-- Download Button -->
    <div class="download-button-container">
        <button id="download-pdf">Download PDF</button>
    </div>

    <!-- Dynamic HTML content -->
    <div id="proposal-content">
      <!-- Header -->
      <div class="header">
        <div class="logo">
           <!-- Logo remains static -->
           <img src="nutz_logo.jpg" alt="Nutz Logo"/>
        </div>
        <div class="company-details">
          <!-- Static company details -->
          <span class="company-name">Nutz Technovation Private Limited</span>
          <span>2nd Floor, KPP Complex, Palayapalayam, Erode - 11</span><br />
          <span>+91 99444 48090 | contact@nutz.in</span> | <span>nutz.in</span><br />
          <span class="company-gstin">GSTIN: <span>33AAHCN3387K1Z4</span></span>
        </div>
      </div>
      <!-- Details -->
      <div class="details-section">
        <div class="recipient-details">
          <h2 style="font-weight: 900;">PROPOSAL TO</h2>
          <!-- Add IDs for dynamic population -->
          <p><span class="label">Name</span><span class="separator">:</span><span class="value" id="client-name"></span></p>
          <p><span class="label">Address</span><span class="separator">:</span><span class="value" id="client-address"></span></p>
          <p><span class="label">Mobile</span><span class="separator">:</span><span class="value" id="client-mobile"></span></p>
          <p><span class="label">E-Mail</span><span class="separator">:</span><span class="value" id="client-email"></span></p>
          <p><span class="label">Website</span><span class="separator">:</span><span class="value" id="client-website"></span></p>
          <p><span class="label">GSTIN</span><span class="separator">:</span><span class="value" id="client-gstin"></span></p>
        </div>
        <div class="quotation-details-wrapper">
          <div class="quotation-details">
             <!-- Add IDs for dynamic population -->
            <div><span class="q-label">Quotation No</span><span class="q-separator">:</span><span class="q-value" id="quote-no"></span></div>
            <div><span class="q-label">Date</span><span class="q-separator">:</span><span class="q-value" id="quote-date"></span></div>
            <div><span class="q-label">Requirement</span><span class="q-separator">:</span><span class="q-value" id="quote-requirement"></span></div>
            <div><span class="q-label">Advance</span><span class="q-separator">:</span><span class="q-value" id="quote-advance"></span></div>
            <div><span class="q-label">Validity Date</span><span class="q-separator">:</span><span class="q-value" id="quote-validity"></span></div>
          </div>
        </div>
      </div>
      <!-- Table Area -->
      <div class="table-area">
        <table class="items-table">
          <thead>
            <tr>
              <th class="col-sno">#</th>
              <th class="col-desc">Description</th>
              <th class="col-qty">No</th> <!-- Changed from Quantity to No -->
              <th class="col-unitprice">Unit Price</th>
              <th class="col-price">Price</th>
            </tr>
          </thead>
          <!-- Add ID for dynamic population -->
          <tbody id="table-body">
            <!-- Table rows will be generated by JavaScript -->
          </tbody>
        </table>
      </div>
      <!-- Totals -->
      <div class="totals-section">
         <!-- Add IDs for dynamic population -->
        <div><span>Sub Total</span><span id="subtotal-value"></span></div>
        <div><span>SGST <span id="sgst-rate-label"></span>%</span><span id="sgst-value"></span></div>
        <div><span>CGST <span id="cgst-rate-label"></span>%</span><span id="cgst-value"></span></div>
        <div><span>Round Off</span><span id="roundoff-value"></span></div>
        <div class="grand-total"><span>Grand Total</span><span id="grandtotal-value"></span></div>
      </div>
      <!-- Footer Sections Wrapper -->
      <div class="footer-sections">
        <!-- Terms -->
        <div class="terms-section">
          <h3>Terms & Conditions:</h3>
          <!-- Add ID for dynamic population -->
          <ol id="terms-list">
             <!-- Terms will be generated by JavaScript -->
          </ol>
        </div>
        <!-- Approval -->
        <div class="approval-section">
          <p>For Nutz Technovation Private Limited,</p>
          <!-- Signature space is handled by margin on name -->
          <!-- Add IDs for dynamic population -->
          <p class="approver-name" id="approver-name"></p>
          <p class="approver-title" id="approver-title"></p>
        </div>
      </div>
      <!-- End footer-sections -->
    </div>
    <!-- End proposal-content -->

    <!-- html2pdf.js Library -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"
      integrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>

    <!-- Calculation and Population Script -->
    <script>
      document.addEventListener('DOMContentLoaded', () => {

        // --- INPUT DATA ---
        const clientData = {
          name: 'Repplen Projects Private Limited',
          address: 'Mullamparappu, Tamil Nadu 638115',
          mobile: '+91 81488 40177',
          email: 'Nil',
          website: 'Nil',
          gstin: 'Nil'
        };

        const quoteData = {
          no: '520',
          date: '18/04/2025',
          requirement: 'Web development',
          advance: '50%',
          validity: '27/04/2025'
        };

        // Use numbers for quantity and unitPrice for calculations
        const tableItems = [
          { sno: 1, description: 'Wordpress Development', quantity: 1, unitPrice: 35000.00 },
          { sno: 2, description: 'Web Hosting (1 Year)', quantity: 1, unitPrice: 5000.00 },
          { sno: 2, description: 'Web Hosting (1 Year)', quantity: 1, unitPrice: 5000.00 },
          // Add more items here if needed
          // { sno: 3, description: 'Another Service', quantity: 2, unitPrice: 1000.00 },
        ];

        const tableNote = 'Theme Purchase Cost Excluded'; // Set to null or empty string if no note

        const taxRates = {
            sgst: 9, // Percentage
            cgst: 9  // Percentage
        };

        const terms = [
          'Additional charges may apply for extra work and revisions.',
          'We require a Non-refundable 50% payment upfront before starting the work, with the remaining 50% due upon completion.',
          'Client must provide necessary materials, feedback, and approvals in a timely manner.',
          'We use the completed project as our Portfolio.'
        ];

        const signatureData = {
          name: 'GOWTHAM KRISHNAMOORTHY',
          title: 'MANAGING DIRECTOR'
        };
        // --- END INPUT DATA ---


        // --- HELPER FUNCTIONS ---
        function formatCurrency(value) {
           // Ensure value is a number and fixed to 2 decimal places
           const numberValue = Number(value);
           if (isNaN(numberValue)) {
               return "INR 0.00"; // Default or error value
           }
           // Format with commas and two decimal places
           return "INR " + numberValue.toLocaleString('en-IN', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        // --- CALCULATION LOGIC ---
        function calculate() {
            let subTotal = 0;
            const calculatedItems = tableItems.map(item => {
                const price = item.quantity * item.unitPrice;
                subTotal += price;
                return { ...item, price }; // Add calculated price to item object
            });

            const sgstAmount = subTotal * (taxRates.sgst / 100);
            const cgstAmount = subTotal * (taxRates.cgst / 100);
            const totalBeforeRoundoff = subTotal + sgstAmount + cgstAmount;

            // --- Rounding Logic ---
            // Option 1: Round to nearest Rupee
            // const grandTotal = Math.round(totalBeforeRoundoff);
            // Option 2: Keep two decimal places (more common for invoices)
            const grandTotal = parseFloat(totalBeforeRoundoff.toFixed(2));

            const roundOff = parseFloat((grandTotal - totalBeforeRoundoff).toFixed(2)); // Calculate round off

            return {
                calculatedItems,
                subTotal,
                sgstAmount,
                cgstAmount,
                roundOff,
                grandTotal
            };
        }


        // --- DOM POPULATION LOGIC ---
        function populateData() {
            const results = calculate(); // Perform calculations

            // Populate Client Details
            document.getElementById('client-name').textContent = clientData.name;
            document.getElementById('client-address').textContent = clientData.address;
            document.getElementById('client-mobile').textContent = clientData.mobile;
            document.getElementById('client-email').textContent = clientData.email;
            document.getElementById('client-website').textContent = clientData.website;
            document.getElementById('client-gstin').textContent = clientData.gstin;

            // Populate Quotation Details
            document.getElementById('quote-no').textContent = quoteData.no;
            document.getElementById('quote-date').textContent = quoteData.date;
            document.getElementById('quote-requirement').textContent = quoteData.requirement;
            document.getElementById('quote-advance').textContent = quoteData.advance;
            document.getElementById('quote-validity').textContent = quoteData.validity;

            // Populate Table
            const tableBody = document.getElementById('table-body');
            tableBody.innerHTML = ''; // Clear existing rows (if any)

            results.calculatedItems.forEach(item => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td class="col-sno">${item.sno}</td>
                    <td class="col-desc">${item.description}</td>
                    <td class="col-qty">${String(item.quantity).padStart(2, '0')}</td>
                    <td class="col-unitprice">${formatCurrency(item.unitPrice)}</td>
                    <td class="col-price">${formatCurrency(item.price)}</td>
                `;
            });

            // Add Note Row if applicable
            if (tableNote) {
                 const noteRow = tableBody.insertRow();
                 noteRow.className = 'item-note';
                 // Calculate colspan based on number of columns
                 const numberOfColumns = tableBody.previousElementSibling.rows[0].cells.length; // Get count from thead
                 noteRow.innerHTML = `<td colspan="${numberOfColumns}"><span>Note:</span> ${tableNote}</td>`;

                 // Adjust borders for the note row - remove internal borders, keep outer
                 const cells = noteRow.getElementsByTagName('td');
                 if (cells.length > 0) {
                     cells[0].style.borderRight = 'none'; // Remove right border if colspan > 1
                     cells[0].style.borderLeft = '1px solid #000'; // Keep left outer border
                     cells[cells.length - 1].style.borderRight = '1px solid #000'; // Keep right outer border
                 }
            }


            // Populate Totals
            document.getElementById('subtotal-value').textContent = formatCurrency(results.subTotal);
            document.getElementById('sgst-rate-label').textContent = taxRates.sgst;
            document.getElementById('sgst-value').textContent = formatCurrency(results.sgstAmount);
            document.getElementById('cgst-rate-label').textContent = taxRates.cgst;
            document.getElementById('cgst-value').textContent = formatCurrency(results.cgstAmount);
            document.getElementById('roundoff-value').textContent = formatCurrency(results.roundOff);
            document.getElementById('grandtotal-value').textContent = formatCurrency(results.grandTotal);

            // Populate Terms
            const termsList = document.getElementById('terms-list');
            termsList.innerHTML = ''; // Clear existing terms
            terms.forEach(term => {
                const li = document.createElement('li');
                li.textContent = term;
                termsList.appendChild(li);
            });

            // Populate Signature
            document.getElementById('approver-name').textContent = signatureData.name;
            document.getElementById('approver-title').textContent = signatureData.title;
        }

        // --- PDF Generation Logic (Mostly unchanged) ---
        const downloadButton = document.getElementById('download-pdf');
        const proposalElement = document.getElementById('proposal-content');

        if (!downloadButton || !proposalElement) {
          console.error("Download button or proposal content element not found!");
          return;
        }

        function generatePDF() {
          console.log("Generating PDF...");

          // Ensure data is populated before generating PDF
          // (Already done by calling populateData() before this event listener is setup)

          const filename = `Proposal_${quoteData.no}_${clientData.name.replace(/[^a-z0-9]/gi, '_')}.pdf`;

          const opt = {
            margin:       [15, 10, 15, 10], // top, left, bottom, right in mm
            filename:     filename,
            image:        { type: 'jpeg', quality: 0.98 },
            html2canvas:  {
                            scale: 3,
                            useCORS: true,
                            logging: false,
                            dpi: 192,
                            letterRendering: true,
                            backgroundColor: '#ffffff'
                          },
            jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' },
            pagebreak:    { mode: ['css', 'avoid-all', 'legacy'] } // Use default modes
          };

          // Temporarily adjust style for better PDF capture
          const originalMargin = proposalElement.style.margin;
          proposalElement.style.margin = '0 auto'; // Remove external margins for capture

          html2pdf().set(opt).from(proposalElement).save().then(() => {
            console.log("PDF Generated Successfully");
            proposalElement.style.margin = originalMargin; // Restore original margin
          }).catch(err => {
            console.error("PDF Generation Error:", err);
            proposalElement.style.margin = originalMargin; // Restore margin on error too
            alert("Error generating PDF. See console for details.");
          });
        }

        // --- Initial Population and Event Binding ---
        populateData(); // Populate the data on page load
        downloadButton.addEventListener('click', generatePDF);

      }); // End DOMContentLoaded
    </script>

  </body>
</html>